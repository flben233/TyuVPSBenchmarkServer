package main

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"time"
)

const baseURL = "http://localhost:12345/report"

// Simple test client for the report API
func main() {
	fmt.Println("VPS Benchmark Report API Test Client")
	fmt.Println("=====================================\n")

	// Wait a moment for server to start
	time.Sleep(time.Second)

	// Test 1: Add a report
	fmt.Println("Test 1: Adding a report...")
	reportID := testAddReport()
	if reportID == "" {
		fmt.Println("❌ Failed to add report")
		return
	}
	fmt.Printf("✅ Report added with ID: %s\n\n", reportID)

	// Test 2: List reports
	fmt.Println("Test 2: Listing reports...")
	testListReports()

	// Test 3: Get report details
	fmt.Println("\nTest 3: Getting report details...")
	testGetReportDetails(reportID)

	// Test 4: Search reports
	fmt.Println("\nTest 4: Searching reports...")
	testSearchReports()

	// Test 5: Delete report
	fmt.Println("\nTest 5: Deleting report...")
	testDeleteReport(reportID)

	fmt.Println("\nAll tests completed!")
}

func testAddReport() string {
	sampleHTML := `<html>
		<head>
			<meta name="title" content="Test Report">
			<meta name="time" content="2025-11-29">
			<meta name="link" content="https://example.com/report">
		</head>
		<body>
			<h1>VPS Benchmark Report</h1>
		</body>
	</html>`

	data := map[string]string{"html": sampleHTML}
	jsonData, _ := json.Marshal(data)

	resp, err := http.Post(baseURL+"/admin/add", "application/json", bytes.NewBuffer(jsonData))
	if err != nil {
		fmt.Printf("Error: %v\n", err)
		return ""
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)
	var result map[string]interface{}
	json.Unmarshal(body, &result)

	if resp.StatusCode == http.StatusCreated {
		return result["report_id"].(string)
	}
	fmt.Printf("Status: %d, Response: %s\n", resp.StatusCode, string(body))
	return ""
}

func testListReports() {
	resp, err := http.Get(baseURL + "/data/list?page=1&page_size=10")
	if err != nil {
		fmt.Printf("Error: %v\n", err)
		return
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)
	var result map[string]interface{}
	json.Unmarshal(body, &result)

	fmt.Printf("✅ Total reports: %.0f\n", result["total"])
	if data, ok := result["data"].([]interface{}); ok {
		fmt.Printf("   Reports on this page: %d\n", len(data))
	}
}

func testGetReportDetails(reportID string) {
	resp, err := http.Get(baseURL + "/data/details?id=" + reportID)
	if err != nil {
		fmt.Printf("Error: %v\n", err)
		return
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)
	if resp.StatusCode == http.StatusOK {
		fmt.Printf("✅ Successfully retrieved report details\n")
		var result map[string]interface{}
		json.Unmarshal(body, &result)
		if data, ok := result["data"].(map[string]interface{}); ok {
			fmt.Printf("   Title: %v\n", data["title"])
		}
	} else {
		fmt.Printf("❌ Failed: %s\n", string(body))
	}
}

func testSearchReports() {
	resp, err := http.Get(baseURL + "/data/search?keyword=Test")
	if err != nil {
		fmt.Printf("Error: %v\n", err)
		return
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)
	var result map[string]interface{}
	json.Unmarshal(body, &result)

	fmt.Printf("✅ Search results: %.0f matches\n", result["total"])
}

func testDeleteReport(reportID string) {
	data := map[string]string{"id": reportID}
	jsonData, _ := json.Marshal(data)

	resp, err := http.Post(baseURL+"/admin/delete", "application/json", bytes.NewBuffer(jsonData))
	if err != nil {
		fmt.Printf("Error: %v\n", err)
		return
	}
	defer resp.Body.Close()

	if resp.StatusCode == http.StatusOK {
		fmt.Printf("✅ Report deleted successfully\n")
	} else {
		body, _ := io.ReadAll(resp.Body)
		fmt.Printf("❌ Failed: %s\n", string(body))
	}
}
